---
title: "Explore Predictor Variables"
author: "Caitlin Mothes"
date: "`r Sys.Date()`"
---

# Explore Predictor Variables

```{r}
source("setup.R")

# read in fort collins boundary
foco_boundary <- read_sf("data/nature_in_the_city/gis/ft_collins_GMA_boundary.shp") %>% 
  # convert boundary line to single polygon
  st_cast("POLYGON") %>% 
  st_make_valid()
```

## Look into NIC greenspace and impervious surface

Note that these are clipped to FoCo boundary

```{r}
greenspace <- read_sf("data/nature_in_the_city/gis/nic_green_space_2015.shp") %>% 
 #invalid polygons, make valid first
   st_make_valid()

imp_surface <- read_sf("data/nature_in_the_city/gis/impervious_surfaces_fort_collins_2015.shp") %>% 
  # invalid polygons, make valid first
  st_make_valid() %>% 
  # transform to crs of foco boundary
  st_transform(crs = st_crs(foco_boundary))
```

Explore via mapping

```{r}
tmap_mode("view")

qtm(greenspace, fill = "green")

# mapping impervious surface takes way too long
```

Convert and save as rasters to reduce file size

```{r}
# create empty raster with ideal pixel size and matching crs
raster_template <- rast(foco_boundary, res = 10)

# convert polygons to rasters
greenspace_raster <- rasterize(greenspace, raster_template)

imp_surface_raster <- rasterize(imp_surface, raster_template, touches = TRUE)

# map it out
tm_shape(greenspace_raster) + 
  tm_raster(col = "layer", palette = "green") +
  tm_shape(imp_surface_raster) + 
  tm_raster(col = "layer", palette = "orange")

# some mismatch and overlap here, may need to decrease raster pixel size OR use raw polygons and calculate distance to impervious surface?
```


## Processing functions


### Green Space

Maybe just add a `distance = TRUE` argument to process_preds

```{r}

file <- "data/nature_in_the_city/gis/nic_green_space_2015.shp"

green_clean <- read_sf(file) %>% 
  # make sure no invalid geometries
  st_make_valid() %>% 
  # transform to crs of foco boundary
  st_transform(crs = st_crs(foco_boundary)) %>% 
  # add a buffer around aoi for distance calculations
  st_crop(st_buffer(foco_boundary, 10)) %>% 
  # merge any overlapping polygons created
  terra::vect()

r_temp <- terra::rast(green_clean, res = 1)

r <- terra::rasterize(green_clean, r_temp)

d <- distance(r)

```

Took almost a minute at 1m res, map it out

```{r}
qtm(d)
```





# Explore NIC model outputs

## Habitat use and connectivity

```{r}
# start with rwbl

rwbl_habitat <- rast("data/nic_wildlife_connectivity_map_v2/probability_of_habitat_use/rwbl_hab_use")

rwbl_cores <- read_sf("data/nic_wildlife_connectivity_map_v2/connectivity_models/rwbl_core_habitat_patches.shp") %>% 
  # fix invalid polygons
  st_make_valid()

rwbl_conn <- rast("data/nic_wildlife_connectivity_map_v2/connectivity_models/rwbl_connect")

```

## Explore outputs

```{r}
tmap_mode("view")

tm_shape(rwbl_habitat) +
  tm_raster(style = "cont") +
  tm_shape(rwbl_conn) +
  tm_raster(style = "cont") +
  tm_shape(rwbl_cores) +
  tm_polygons()


```

See how cores relate to natural habitat
```{r}
natural_habitat <- read_sf("data/input_raw/Natural_Habitat/bc8f7f07-7560-4191-aa2e-8f274a1c29e7202046-1-133oxp5.v8wfi.shp")

tm_shape(natural_habitat) +
  tm_polygons(col = "red") +
  tm_shape(rwbl_cores) + 
  tm_polygons(col = "blue")
```

